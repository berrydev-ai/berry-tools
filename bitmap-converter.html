<!doctype html>
<html lang="en" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LCD Bitmap Converter</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            border: "hsl(240 3.7% 15.9%)",
                            background: "hsl(240 10% 3.9%)",
                            foreground: "hsl(0 0% 98%)",
                        },
                    },
                },
            };
        </script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

            * {
                font-family:
                    "Inter",
                    system-ui,
                    -apple-system,
                    sans-serif;
            }

            body {
                background-color: hsl(240 10% 3.9%);
                color: hsl(0 0% 98%);
            }

            .card {
                border-radius: 0.5rem;
                border: 1px solid hsl(240 3.7% 15.9%);
                background-color: hsl(240 10% 3.9%);
            }

            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                border-radius: 0.375rem;
                font-size: 0.875rem;
                font-weight: 500;
                transition: all 0.2s;
                cursor: pointer;
                padding: 0.5rem 1rem;
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-primary {
                background-color: hsl(0 0% 98%);
                color: hsl(240 5.9% 10%);
            }

            .btn-primary:hover:not(:disabled) {
                background-color: hsl(0 0% 90%);
            }

            .btn-outline {
                border: 1px solid hsl(240 3.7% 15.9%);
                background-color: transparent;
                color: hsl(0 0% 98%);
            }

            .btn-outline:hover:not(:disabled) {
                background-color: hsl(240 3.7% 15.9%);
            }

            .input {
                height: 2.5rem;
                width: 100%;
                border-radius: 0.375rem;
                border: 1px solid hsl(240 3.7% 15.9%);
                background-color: hsl(240 10% 3.9%);
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                color: hsl(0 0% 98%);
            }

            .input::placeholder {
                color: hsl(240 5% 64.9%);
            }

            .radio-card {
                border: 1px solid hsl(240 3.7% 15.9%);
                border-radius: 0.5rem;
                padding: 1rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .radio-card:hover {
                background-color: hsl(240 5.9% 10%);
            }

            .radio-card.selected {
                border-color: hsl(0 0% 98%);
                background-color: hsl(240 5.9% 10%);
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useRef, useEffect } = React;

            class ImageProcessor {
                static toMonochrome(imageData) {
                    const { data, width, height } = imageData;
                    const mono = new Uint8ClampedArray(width * height);
                    const errors = new Float32Array(width * height);

                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            const idx = y * width + x;
                            const pixelIdx = idx * 4;
                            const gray =
                                0.299 * data[pixelIdx] +
                                0.587 * data[pixelIdx + 1] +
                                0.114 * data[pixelIdx + 2];
                            const value = gray + errors[idx];
                            const newValue = value < 128 ? 0 : 255;
                            const error = value - newValue;
                            mono[idx] = newValue;

                            if (x + 1 < width)
                                errors[idx + 1] += (error * 7) / 16;
                            if (y + 1 < height) {
                                if (x > 0)
                                    errors[idx + width - 1] += (error * 3) / 16;
                                errors[idx + width] += (error * 5) / 16;
                                if (x + 1 < width)
                                    errors[idx + width + 1] += (error * 1) / 16;
                            }
                        }
                    }
                    return { data: mono, width, height };
                }

                static invert(monoData) {
                    const inverted = new Uint8ClampedArray(
                        monoData.data.length,
                    );
                    for (let i = 0; i < monoData.data.length; i++) {
                        inverted[i] = monoData.data[i] === 0 ? 255 : 0;
                    }
                    return { ...monoData, data: inverted };
                }

                static sanitizeFilename(filename) {
                    return filename
                        .replace(/[\s-]/g, "_")
                        .replace(/[^a-zA-Z0-9_]/g, "");
                }

                static convertToHorizontal(monoData, filename) {
                    const { width, height } = monoData;
                    const padWidth = width % 8 === 0 ? 0 : 8 - (width % 8);
                    const padHeight = height % 8 === 0 ? 0 : 8 - (height % 8);
                    const paddedWidth = width + padWidth;
                    const paddedHeight = height + padHeight;
                    const paddedData = new Uint8ClampedArray(
                        paddedWidth * paddedHeight,
                    );

                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            paddedData[y * paddedWidth + x] =
                                monoData.data[y * width + x];
                        }
                    }

                    const safeName = this.sanitizeFilename(filename);
                    let output = `#define ${safeName}_width ${width}\n#define ${safeName}_height ${height}\n\n`;
                    output += `const unsigned char ${safeName}_bmp[] PROGMEM = {\n`;

                    let byteArray = [];
                    for (let y = 0; y < paddedHeight; y++) {
                        for (let x = 0; x < paddedWidth; x += 16) {
                            let byte1 = 0;
                            for (let bit = 0; bit < 8; bit++) {
                                if (
                                    paddedData[
                                        y * paddedWidth + x + 8 + bit
                                    ] === 255
                                )
                                    byte1 |= 1 << bit;
                            }
                            let byte2 = 0;
                            for (let bit = 0; bit < 8; bit++) {
                                if (
                                    paddedData[y * paddedWidth + x + bit] ===
                                    255
                                )
                                    byte2 |= 1 << bit;
                            }
                            byteArray.push(
                                `0x${byte1.toString(16).padStart(2, "0")}`,
                            );
                            byteArray.push(
                                `0x${byte2.toString(16).padStart(2, "0")}`,
                            );
                        }
                    }

                    for (let i = 0; i < byteArray.length; i += 16) {
                        const chunk = byteArray.slice(i, i + 16);
                        output += "  " + chunk.join(", ");
                        if (i + 16 < byteArray.length) output += ",";
                        output += "\n";
                    }
                    output += "};";
                    return output;
                }
            }

            function App() {
                const [images, setImages] = useState([]);
                const [customFilename, setCustomFilename] = useState("");
                const [output, setOutput] = useState("");
                const [dragOver, setDragOver] = useState(false);
                const [showToast, setShowToast] = useState(false);

                const fileInputRef = useRef(null);

                useEffect(() => {
                    if (showToast) {
                        const timer = setTimeout(
                            () => setShowToast(false),
                            3000,
                        );
                        return () => clearTimeout(timer);
                    }
                }, [showToast]);

                const loadImage = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new window.Image();
                            img.onload = () => {
                                const canvas = document.createElement("canvas");
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext("2d");
                                ctx.drawImage(img, 0, 0);

                                const baseName = file.name.replace(
                                    /\.[^/.]+$/,
                                    "",
                                );

                                const imageData = ctx.getImageData(
                                    0,
                                    0,
                                    img.width,
                                    img.height,
                                );
                                const mono =
                                    ImageProcessor.toMonochrome(imageData);

                                resolve({
                                    id: Date.now() + Math.random(),
                                    filename: baseName,
                                    width: img.width,
                                    height: img.height,
                                    monoData: mono,
                                    originalFile: file,
                                });
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                };

                const handleFileSelect = async (files) => {
                    const imageFiles = Array.from(files).filter((f) =>
                        f.type.match("image.*"),
                    );
                    if (imageFiles.length === 0) return;

                    const loadedImages = await Promise.all(
                        imageFiles.map((f) => loadImage(f)),
                    );
                    setImages((prev) => [...prev, ...loadedImages]);
                };

                const handleRemoveImage = (id) => {
                    setImages((prev) => prev.filter((img) => img.id !== id));
                };

                const handleConvertAll = () => {
                    if (images.length === 0) return;

                    let combinedOutput =
                        "// Generated bitmap arrays for " +
                        images.length +
                        " image(s)\n";
                    combinedOutput +=
                        "// Generated on " +
                        new Date().toLocaleString() +
                        "\n\n";

                    images.forEach((img, index) => {
                        const safeName = ImageProcessor.sanitizeFilename(
                            img.filename,
                        );
                        const result = ImageProcessor.convertToHorizontal(
                            img.monoData,
                            safeName,
                        );

                        if (index > 0) combinedOutput += "\n\n";
                        combinedOutput +=
                            "// " +
                            img.filename +
                            " (" +
                            img.width +
                            "x" +
                            img.height +
                            ")\n";
                        combinedOutput += result;
                    });

                    setOutput(combinedOutput);
                };

                const handleCopy = async () => {
                    if (!output) return;
                    try {
                        await navigator.clipboard.writeText(output);
                        setShowToast(true);
                    } catch (err) {
                        console.error("Failed to copy:", err);
                    }
                };

                const handleSave = () => {
                    if (!output) return;
                    const blob = new Blob([output], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `bitmaps_${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                };

                const handleDrop = (e) => {
                    e.preventDefault();
                    setDragOver(false);
                    handleFileSelect(e.dataTransfer.files);
                };

                return (
                    <div className="min-h-screen p-6 md:p-8">
                        <div className="max-w-7xl mx-auto space-y-6">
                            <div className="space-y-2">
                                <h1 className="text-3xl font-bold">
                                    LCD Bitmap Converter
                                </h1>
                                <p className="text-gray-400">
                                    Convert images to monochrome bitmap arrays
                                    for OLED/LCD displays
                                </p>
                            </div>

                            <div className="grid lg:grid-cols-2 gap-6">
                                {/* Left Column */}
                                <div className="space-y-6">
                                    <div className="card p-6 space-y-4">
                                        <h2 className="text-lg font-semibold flex items-center gap-2">
                                            <span>üìÅ</span> Upload Images
                                        </h2>

                                        <div
                                            className={`border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-colors ${
                                                dragOver
                                                    ? "border-white bg-gray-800"
                                                    : "border-gray-700 hover:border-gray-500"
                                            }`}
                                            onClick={() =>
                                                fileInputRef.current?.click()
                                            }
                                            onDragOver={(e) => {
                                                e.preventDefault();
                                                setDragOver(true);
                                            }}
                                            onDragLeave={() =>
                                                setDragOver(false)
                                            }
                                            onDrop={handleDrop}
                                        >
                                            <div className="text-5xl mb-4">
                                                üìÅ
                                            </div>
                                            <p className="text-sm font-medium mb-1">
                                                Click to upload or drag and drop
                                            </p>
                                            <p className="text-xs text-gray-400">
                                                PNG, JPG, BMP supported ‚Ä¢
                                                Multiple files allowed
                                            </p>
                                            <input
                                                ref={fileInputRef}
                                                type="file"
                                                accept="image/*"
                                                multiple
                                                className="hidden"
                                                onChange={(e) =>
                                                    handleFileSelect(
                                                        e.target.files,
                                                    )
                                                }
                                            />
                                        </div>

                                        <div className="flex items-start gap-2 p-3 bg-gray-800 rounded-md border border-gray-700">
                                            <span>‚ÑπÔ∏è</span>
                                            <p className="text-xs text-gray-400">
                                                White pixels = lit/on, Black
                                                pixels = off (correct for
                                                SSD1306)
                                            </p>
                                        </div>
                                    </div>

                                    {/* Image Preview Grid */}
                                    {images.length > 0 && (
                                        <div className="card p-6 space-y-4">
                                            <div className="flex items-center justify-between">
                                                <h2 className="text-lg font-semibold flex items-center gap-2">
                                                    <span>üñºÔ∏è</span> Images (
                                                    {images.length})
                                                </h2>
                                                <button
                                                    className="text-xs text-red-400 hover:text-red-300 underline"
                                                    onClick={() => {
                                                        setImages([]);
                                                        setOutput("");
                                                    }}
                                                >
                                                    Remove All
                                                </button>
                                            </div>

                                            <div className="flex flex-wrap gap-3 max-h-[600px] overflow-y-auto">
                                                {images.map((img) => (
                                                    <div
                                                        key={img.id}
                                                        className="border border-gray-700 rounded-lg overflow-hidden inline-block hover:border-gray-500 transition-colors"
                                                    >
                                                        {/* Preview Canvas */}
                                                        <div className="bg-gray-800 p-2 flex items-center justify-center">
                                                            <canvas
                                                                ref={(el) => {
                                                                    if (
                                                                        el &&
                                                                        img.monoData
                                                                    ) {
                                                                        el.width =
                                                                            img.monoData.width;
                                                                        el.height =
                                                                            img.monoData.height;
                                                                        const ctx =
                                                                            el.getContext(
                                                                                "2d",
                                                                            );
                                                                        const imageData =
                                                                            ctx.createImageData(
                                                                                img
                                                                                    .monoData
                                                                                    .width,
                                                                                img
                                                                                    .monoData
                                                                                    .height,
                                                                            );
                                                                        for (
                                                                            let i = 0;
                                                                            i <
                                                                            img
                                                                                .monoData
                                                                                .data
                                                                                .length;
                                                                            i++
                                                                        ) {
                                                                            const idx =
                                                                                i *
                                                                                4;
                                                                            const val =
                                                                                img
                                                                                    .monoData
                                                                                    .data[
                                                                                    i
                                                                                ];
                                                                            imageData.data[
                                                                                idx
                                                                            ] =
                                                                                val;
                                                                            imageData.data[
                                                                                idx +
                                                                                    1
                                                                            ] =
                                                                                val;
                                                                            imageData.data[
                                                                                idx +
                                                                                    2
                                                                            ] =
                                                                                val;
                                                                            imageData.data[
                                                                                idx +
                                                                                    3
                                                                            ] =
                                                                                255;
                                                                        }
                                                                        ctx.putImageData(
                                                                            imageData,
                                                                            0,
                                                                            0,
                                                                        );
                                                                    }
                                                                }}
                                                                style={{
                                                                    imageRendering:
                                                                        "pixelated",
                                                                    width: "auto",
                                                                    height: "auto",
                                                                }}
                                                            />
                                                        </div>

                                                        {/* Info Bar with Remove Button */}
                                                        <div className="bg-gray-900 px-2 py-1 flex items-center justify-between">
                                                            <div className="flex-1 min-w-0">
                                                                <p
                                                                    className="text-xs font-medium truncate"
                                                                    style={{
                                                                        maxWidth:
                                                                            "100px",
                                                                    }}
                                                                >
                                                                    {
                                                                        img.filename
                                                                    }
                                                                </p>
                                                                <p className="text-xs text-gray-500">
                                                                    {img.width}√ó
                                                                    {img.height}
                                                                </p>
                                                            </div>
                                                            <button
                                                                onClick={() =>
                                                                    handleRemoveImage(
                                                                        img.id,
                                                                    )
                                                                }
                                                                className="ml-2 text-gray-500 hover:text-gray-300 text-xs transition-colors"
                                                                title="Remove"
                                                            >
                                                                √ó
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {images.length === 0 && (
                                        <div className="card p-6">
                                            <p className="text-center text-gray-400 py-12">
                                                No images uploaded yet. Drag and
                                                drop or click to upload.
                                            </p>
                                        </div>
                                    )}

                                    <div className="card p-6 space-y-4">
                                        <h2 className="text-lg font-semibold flex items-center gap-2">
                                            <span>‚öôÔ∏è</span> Actions
                                        </h2>
                                        <button
                                            className="btn btn-primary w-full"
                                            onClick={handleConvertAll}
                                            disabled={images.length === 0}
                                        >
                                            <span>‚ö°</span> Convert All{" "}
                                            {images.length > 0
                                                ? `(${images.length})`
                                                : ""}
                                        </button>
                                    </div>
                                </div>

                                {/* Right Column */}
                                <div
                                    className="card p-6 space-y-4 lg:sticky lg:top-6"
                                    style={{ maxHeight: "calc(100vh - 3rem)" }}
                                >
                                    <h2 className="text-lg font-semibold flex items-center gap-2">
                                        <span>üíª</span> Output
                                        {output && (
                                            <span className="ml-auto text-xs text-gray-400">
                                                {images.length} array
                                                {images.length !== 1 ? "s" : ""}
                                            </span>
                                        )}
                                    </h2>
                                    <div
                                        className="border border-gray-700 rounded-lg bg-gray-800 p-4 font-mono text-xs overflow-auto"
                                        style={{
                                            height: "calc(100vh - 16rem)",
                                        }}
                                    >
                                        {output ? (
                                            <pre className="text-white">
                                                {output}
                                            </pre>
                                        ) : (
                                            <p className="text-gray-400 text-center py-20">
                                                {images.length > 0
                                                    ? 'Click "Convert All" to generate bitmap arrays'
                                                    : "Upload images to get started"}
                                            </p>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button
                                            className="btn btn-outline"
                                            onClick={handleCopy}
                                            disabled={!output}
                                        >
                                            <span>üìã</span> Copy
                                        </button>
                                        <button
                                            className="btn btn-primary"
                                            onClick={handleSave}
                                            disabled={!output}
                                        >
                                            <span>üíæ</span> Save
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {showToast && (
                                <div
                                    className="fixed bottom-6 right-6"
                                    style={{
                                        animation: "slideIn 0.3s ease-out",
                                    }}
                                >
                                    <div className="card p-4 flex items-center gap-3 shadow-lg border-white">
                                        <div className="w-8 h-8 rounded-full bg-white text-black flex items-center justify-center text-xl">
                                            ‚úì
                                        </div>
                                        <div>
                                            <p className="font-medium text-sm">
                                                Copied to clipboard
                                            </p>
                                            <p className="text-xs text-gray-400">
                                                All bitmap arrays ready to paste
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            ReactDOM.render(<App />, document.getElementById("root"));
        </script>
    </body>
</html>
